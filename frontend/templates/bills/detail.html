{% extends "base.html" %}

{% block title %}Bill Detail - Skanda Credit & Billing{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Bill: {{ bill.bill_number }}</h1>
    <a href="{{ url_for('bill.list') }}" class="btn btn-secondary">Back to List</a>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Bill Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Vendor:</strong></div>
                    <div class="col-md-9">{{ bill.vendor.name }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Date:</strong></div>
                    <div class="col-md-9">{{ bill.bill_date.strftime('%Y-%m-%d') }}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Type:</strong></div>
                    <div class="col-md-9"><span class="badge bg-secondary">{{ bill.bill_type }}</span></div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Status:</strong></div>
                    <div class="col-md-9">
                        {% if bill.status == 'DRAFT' %}
                            <span class="badge bg-warning">DRAFT</span>
                        {% elif bill.status == 'CONFIRMED' %}
                            <span class="badge bg-success">CONFIRMED</span>
                        {% else %}
                            <span class="badge bg-danger">CANCELLED</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Payment Status:</strong></div>
                    <div class="col-md-9">
                        {% if payment_status == 'FULLY_PAID' %}
                            <span class="badge bg-success">FULLY PAID</span>
                        {% elif payment_status == 'PARTIALLY_PAID' %}
                            <span class="badge bg-info">PARTIALLY PAID</span>
                        {% else %}
                            <span class="badge bg-warning">UNPAID</span>
                        {% endif %}
                    </div>
                </div>
                {% if payment_status != 'UNPAID' %}
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Total Paid:</strong></div>
                    <div class="col-md-9">₹{{ "%.2f"|format(total_paid) }} / ₹{{ "%.2f"|format(bill.amount_total) }}</div>
                </div>
                {% if payment_status == 'PARTIALLY_PAID' %}
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Remaining:</strong></div>
                    <div class="col-md-9"><strong class="text-danger">₹{{ "%.2f"|format(remaining) }}</strong></div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Items</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bill.items %}
                            <tr>
                                <td>{{ item.description }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>₹{{ "%.2f"|format(item.unit_price) }}</td>
                                <td>₹{{ "%.2f"|format(item.amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Subtotal</th>
                                <th>₹{{ "%.2f"|format(bill.amount_subtotal) }}</th>
                            </tr>
                            <tr>
                                <th colspan="3">Tax</th>
                                <th>₹{{ "%.2f"|format(bill.amount_tax) }}</th>
                            </tr>
                            <tr>
                                <th colspan="3">Total</th>
                                <th>₹{{ "%.2f"|format(bill.amount_total) }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Actions</h5>
            </div>
            <div class="card-body">
                <!-- Authorization Status -->
                <div class="mb-3">
                    <strong>Authorization Status:</strong>
                    {% if bill.is_authorized %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> Authorized
                        </span>
                        {% if bill.authorized_by and bill.authorized_at %}
                            <br><small class="text-muted">
                                Authorized by {{ bill.authorizer.username if bill.authorizer else 'Admin' }} 
                                on {{ bill.authorized_at.strftime('%Y-%m-%d %H:%M') }}
                            </small>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-warning">
                            <i class="bi bi-exclamation-triangle"></i> Not Authorized
                        </span>
                        <br><small class="text-muted">Organiser cannot view this bill</small>
                    {% endif %}
                </div>
                
                <!-- Admin Authorization Actions -->
                {% if has_permission('authorize_bill') %}
                    {% if bill.is_authorized %}
                        <form method="POST" action="{{ url_for('bill.unauthorize', id=bill.id) }}" class="mb-2" onsubmit="return confirm('Unauthorize this bill? Organiser will no longer be able to view it.');">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-x-circle"></i> Unauthorize Bill
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('bill.authorize', id=bill.id) }}" class="mb-2" onsubmit="return confirm('Authorize this bill? Organiser will be able to view it.');">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-check-circle"></i> Authorize Bill
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
                
                {% if bill.status == 'DRAFT' and has_permission('confirm_bill') %}
                    <form method="POST" action="{{ url_for('bill.confirm', id=bill.id) }}" class="mb-2">
                        <button type="submit" class="btn btn-success w-100">Confirm Bill</button>
                    </form>
                {% endif %}
                {% if bill.status != 'CANCELLED' and has_permission('cancel_bill') %}
                    <form method="POST" action="{{ url_for('bill.cancel', id=bill.id) }}" class="mb-2" onsubmit="return confirm('Are you sure?');">
                        <button type="submit" class="btn btn-danger w-100">Cancel Bill</button>
                    </form>
                {% endif %}
                
                {% if payment_status != 'FULLY_PAID' and bill.status != 'CANCELLED' and has_permission('create_credit') %}
                    <button type="button" class="btn btn-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#markPaidModal">
                        {% if payment_status == 'PARTIALLY_PAID' %}Add Payment{% else %}Mark as Paid{% endif %}
                    </button>
                {% endif %}
                
                {% if has_permission('create_credit') %}
                <a href="{{ url_for('credit.create', bill_id=bill.id, vendor_id=bill.vendor_id) }}" class="btn btn-info w-100 mb-2">Add Credit Payment</a>
                {% endif %}
                {% if has_permission('create_bill') %}
                <a href="{{ url_for('proxy.create', parent_bill_id=bill.id) }}" class="btn btn-warning w-100 mb-2">Create Proxy Bill</a>
                <a href="{{ url_for('ocr.upload', bill_id=bill.id) }}" class="btn btn-secondary w-100 mb-2">Upload OCR Image</a>
                {% endif %}
            </div>
        </div>
        
        <!-- Mark as Paid Modal -->
        <div class="modal fade" id="markPaidModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Record Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="POST" action="{{ url_for('bill.mark_paid', id=bill.id) }}">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Payment Type</label>
                                <select name="payment_type" id="modalPaymentType" class="form-select" required>
                                    <option value="FULL">Fully Paid</option>
                                    <option value="PARTIAL" {% if payment_status == 'PARTIALLY_PAID' %}selected{% endif %}>Partially Paid</option>
                                </select>
                            </div>
                            <div class="mb-3" id="modalPartialAmount" style="display: none;">
                                <label class="form-label">Partial Payment Amount</label>
                                <input type="number" step="0.01" name="partial_amount" class="form-control" 
                                       placeholder="Enter amount" min="0.01" max="{{ bill.amount_total }}">
                                <small class="form-text text-muted">Remaining: ₹{{ "%.2f"|format(remaining) }}</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Payment Method</label>
                                <select name="payment_method" class="form-select" required>
                                    <option value="CASH">Cash</option>
                                    <option value="UPI">UPI</option>
                                    <option value="BANK">Bank Transfer</option>
                                    <option value="CHEQUE">Cheque</option>
                                    <option value="CARD">Card</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Payment Date</label>
                                <input type="date" name="payment_date" class="form-control" value="{{ bill.bill_date.strftime('%Y-%m-%d') }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Payment Reference (Optional)</label>
                                <input type="text" name="payment_reference" class="form-control" placeholder="Transaction ID, Cheque Number, etc.">
                            </div>
                            <div class="alert alert-info">
                                <strong>Bill Total:</strong> ₹{{ "%.2f"|format(bill.amount_total) }}<br>
                                {% if payment_status == 'PARTIALLY_PAID' %}
                                <strong>Already Paid:</strong> ₹{{ "%.2f"|format(total_paid) }}<br>
                                <strong>Remaining:</strong> ₹{{ "%.2f"|format(remaining) }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Record Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const modalPaymentType = document.getElementById('modalPaymentType');
            const modalPartialAmount = document.getElementById('modalPartialAmount');
            
            if (modalPaymentType) {
                modalPaymentType.addEventListener('change', function() {
                    if (this.value === 'PARTIAL') {
                        modalPartialAmount.style.display = 'block';
                    } else {
                        modalPartialAmount.style.display = 'none';
                    }
                });
                
                // Trigger on load
                if (modalPaymentType.value === 'PARTIAL') {
                    modalPartialAmount.style.display = 'block';
                }
            }
        });
        </script>
        
        {% if credits %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Credit Entries</h5>
            </div>
            <div class="card-body">
                {% for credit in credits %}
                <div class="mb-2">
                    <strong>₹{{ "%.2f"|format(credit.amount) }}</strong> - {{ credit.direction }}<br>
                    <small class="text-muted">{{ credit.payment_date.strftime('%Y-%m-%d') }} - {{ credit.payment_method }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if proxy_bills %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Proxy Bills</h5>
            </div>
            <div class="card-body">
                {% for pb in proxy_bills %}
                <div class="mb-2">
                    <a href="{{ url_for('proxy.detail', id=pb.id) }}">{{ pb.proxy_number }}</a><br>
                    <small class="text-muted">₹{{ "%.2f"|format(pb.amount_total) }}</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

