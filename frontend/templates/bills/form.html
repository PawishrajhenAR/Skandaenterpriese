{% extends "base.html" %}

{% block title %}New Bill - Skanda Credit & Billing{% endblock %}

{% block content %}
<h1 class="mb-4">New Bill</h1>

<!-- OCR Upload Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-bottom py-3">
        <h5 class="mb-0"><i class="bi bi-camera me-2"></i>Upload Bill Image (Optional - OCR)</h5>
    </div>
    <div class="card-body p-4">
        <div class="mb-3">
            <label class="form-label">Upload Bill Image for OCR</label>
            <div class="file-upload-form">
                <label for="ocr_image" class="file-upload-label" id="ocrFileUploadLabel">
                    <div class="file-upload-design">
                        <svg viewBox="0 0 640 512" height="1em">
                            <path
                                d="M144 480C64.5 480 0 415.5 0 336c0-62.8 40.2-116.2 96.2-135.9c-.1-2.7-.2-5.4-.2-8.1c0-88.4 71.6-160 160-160c59.3 0 111 32.2 138.7 80.2C409.9 102 428.3 96 448 96c53 0 96 43 96 96c0 12.2-2.3 23.8-6.4 34.6C596 238.4 640 290.1 640 352c0 70.7-57.3 128-128 128H144zm79-217c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l39-39V392c0 13.3 10.7 24 24 24s24-10.7 24-24V257.9l39 39c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0l-80 80z"
                            ></path>
                        </svg>
                        <p>Drag and Drop</p>
                        <p>or</p>
                        <span class="browse-button">Browse file</span>
                        <p id="ocrFileName" style="margin-top: 15px; font-size: 0.875rem; display: none;"></p>
                    </div>
                    <input type="file" id="ocr_image" accept="image/*,.pdf" style="display: none;">
                </label>
            </div>
            <small class="form-text text-muted d-block mt-2 text-center">Upload an image to extract bill information automatically</small>
            <!-- Loading indicator -->
            <div id="ocrLoading" class="alert alert-info d-none mt-3 mb-0">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>
                        <strong>Processing OCR...</strong>
                        <div class="small">This may take 10-30 seconds. Please wait...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OCR Preview Modal -->
<div class="modal fade" id="ocrPreviewModal" tabindex="-1" aria-labelledby="ocrPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ocrPreviewModalLabel">
                    <i class="bi bi-check-circle me-2"></i>OCR Data Extracted
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Please review the extracted data below and confirm to auto-fill the form.</strong>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary mb-2"><i class="bi bi-file-text me-2"></i>Extracted Text:</h6>
                    <pre id="ocrTextPreview" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 0.875rem;"></pre>
                </div>
                
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="text-primary mb-2"><i class="bi bi-card-text me-2"></i>Extracted Information:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <tbody>
                                    <tr>
                                        <td class="fw-semibold" style="width: 40%;">Invoice Number:</td>
                                        <td id="previewBillNumber" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Bill Date:</td>
                                        <td id="previewBillDate" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Vendor Name:</td>
                                        <td id="previewVendorName" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Subtotal:</td>
                                        <td id="previewSubtotal" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Tax:</td>
                                        <td id="previewTax" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Total:</td>
                                        <td id="previewTotal" class="fw-bold text-primary">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Total Net:</td>
                                        <td id="previewTotalNet" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Billed To:</td>
                                        <td id="previewBilledTo" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Shipped To:</td>
                                        <td id="previewShippedTo" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Delivery Date:</td>
                                        <td id="previewDeliveryDate" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Delivery Recipient (DR):</td>
                                        <td id="previewDeliveryRecipient" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Post:</td>
                                        <td id="previewPost" class="text-muted">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmOCRData">
                    <i class="bi bi-check-circle me-2"></i>Confirm & Auto-Fill Form
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" id="billForm" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.vendor_id.label(class="form-label") }}
                    {{ form.vendor_id(class="form-select") }}
                    {% if form.vendor_id.errors %}
                        <div class="text-danger small">{{ form.vendor_id.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <label for="bill_number" class="form-label">Invoice Number</label>
                    {{ form.bill_number(class="form-control") }}
                    {% if form.bill_number.errors %}
                        <div class="text-danger small">{{ form.bill_number.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {{ form.bill_date.label(class="form-label") }}
                    {{ form.bill_date(class="form-control") }}
                    {% if form.bill_date.errors %}
                        <div class="text-danger small">{{ form.bill_date.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {{ form.delivery_date.label(class="form-label") }}
                    {{ form.delivery_date(class="form-control") }}
                    {% if form.delivery_date.errors %}
                        <div class="text-danger small">{{ form.delivery_date.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    {{ form.billed_to_name.label(class="form-label") }}
                    {{ form.billed_to_name(class="form-control") }}
                    {% if form.billed_to_name.errors %}
                        <div class="text-danger small">{{ form.billed_to_name.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ form.shipped_to_name.label(class="form-label") }}
                    {{ form.shipped_to_name(class="form-control") }}
                    {% if form.shipped_to_name.errors %}
                        <div class="text-danger small">{{ form.shipped_to_name.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ form.delivery_recipient.label(class="form-label") }}
                    {{ form.delivery_recipient(class="form-control") }}
                    {% if form.delivery_recipient.errors %}
                        <div class="text-danger small">{{ form.delivery_recipient.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    {{ form.post.label(class="form-label") }}
                    {{ form.post(class="form-control") }}
                    {% if form.post.errors %}
                        <div class="text-danger small">{{ form.post.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    {{ form.bill_type.label(class="form-label") }}
                    {{ form.bill_type(class="form-select") }}
                    {% if form.bill_type.errors %}
                        <div class="text-danger small">{{ form.bill_type.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ form.is_proxy.label(class="form-label") }}
                    {{ form.is_proxy(class="form-select") }}
                    {% if form.is_proxy.errors %}
                        <div class="text-danger small">{{ form.is_proxy.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4" id="splitsContainer" style="display: none;">
                    {{ form.number_of_splits.label(class="form-label") }}
                    {{ form.number_of_splits(class="form-control") }}
                    {% if form.number_of_splits.errors %}
                        <div class="text-danger small">{{ form.number_of_splits.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            
            <hr>
            <h5>Payment Information</h5>
            <div class="row mb-3">
                <div class="col-md-3">
                    {{ form.payment_type.label(class="form-label") }}
                    {{ form.payment_type(class="form-select") }}
                    {% if form.payment_type.errors %}
                        <div class="text-danger small">{{ form.payment_type.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3" id="partialAmountContainer" style="display: none;">
                    {{ form.partial_amount.label(class="form-label") }}
                    {{ form.partial_amount(class="form-control") }}
                    {% if form.partial_amount.errors %}
                        <div class="text-danger small">{{ form.partial_amount.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3" id="paymentMethodContainer" style="display: none;">
                    {{ form.payment_method.label(class="form-label") }}
                    {{ form.payment_method(class="form-select") }}
                    {% if form.payment_method.errors %}
                        <div class="text-danger small">{{ form.payment_method.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3" id="paymentRefContainer" style="display: none;">
                    {{ form.payment_reference.label(class="form-label") }}
                    {{ form.payment_reference(class="form-control") }}
                    {% if form.payment_reference.errors %}
                        <div class="text-danger small">{{ form.payment_reference.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            
            <hr>
            <h5>Amounts</h5>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Subtotal</label>
                    <input type="number" step="0.01" name="amount_subtotal" class="form-control" id="subtotal" value="0.00" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tax (18%)</label>
                    <input type="number" step="0.01" name="amount_tax" class="form-control" id="tax" value="0.00" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Total</label>
                    <input type="number" step="0.01" name="amount_total" class="form-control" id="total" value="0.00" required>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Bill</button>
                <a href="{{ url_for('bill.list') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isProxySelect = document.getElementById('is_proxy');
    const splitsContainer = document.getElementById('splitsContainer');
    const ocrImageInput = document.getElementById('ocr_image');
    const ocrFileUploadLabel = document.getElementById('ocrFileUploadLabel');
    const ocrFileName = document.getElementById('ocrFileName');
    const ocrLoading = document.getElementById('ocrLoading');
    const ocrResult = document.getElementById('ocrResult');
    const ocrText = document.getElementById('ocrText');
    
    // Store OCR data globally
    let ocrData = null;
    
    // Function to process OCR automatically
    function processOCR(file) {
        if (!file) {
            return;
        }
        
        // Show file name
        ocrFileName.textContent = file.name;
        ocrFileName.style.display = 'block';
        
        // Show loading indicator
        ocrLoading.classList.remove('d-none');
        
        const formData = new FormData();
        formData.append('ocr_image', file);
        
        fetch('{{ url_for("bill.ocr_upload") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            // Check if response is ok
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `Server error: ${response.status}`);
                }).catch(() => {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                ocrData = data;
                showOCRPreview(data);
            } else {
                alert('OCR processing failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('OCR Error Details:', error);
            let errorMessage = 'Error processing OCR';
            if (error.message) {
                errorMessage += ': ' + error.message;
            } else if (error instanceof TypeError && error.message.includes('fetch')) {
                errorMessage = 'Failed to connect to server. Please check your connection and try again.';
            } else {
                errorMessage = 'An unexpected error occurred. Please try again.';
            }
            alert(errorMessage);
        })
        .finally(() => {
            // Hide loading indicator
            ocrLoading.classList.add('d-none');
        });
    }
    
    // Drag and drop functionality for OCR upload
    ocrFileUploadLabel.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        ocrFileUploadLabel.classList.add('drag-over');
    });
    
    ocrFileUploadLabel.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        ocrFileUploadLabel.classList.remove('drag-over');
    });
    
    ocrFileUploadLabel.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        ocrFileUploadLabel.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            ocrImageInput.files = files;
            processOCR(files[0]);
        }
    });
    
    // Auto-process when file is selected via browse
    ocrImageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            processOCR(file);
        } else {
            ocrFileName.textContent = '';
            ocrFileName.style.display = 'none';
        }
    });
    
    const paymentTypeSelect = document.getElementById('payment_type');
    const partialAmountContainer = document.getElementById('partialAmountContainer');
    const paymentMethodContainer = document.getElementById('paymentMethodContainer');
    const paymentRefContainer = document.getElementById('paymentRefContainer');
    
    // Show/hide splits field based on proxy selection
    isProxySelect.addEventListener('change', function() {
        if (this.value === 'YES') {
            splitsContainer.style.display = 'block';
        } else {
            splitsContainer.style.display = 'none';
        }
    });
    
    // Show/hide payment fields based on payment type
    paymentTypeSelect.addEventListener('change', function() {
        if (this.value === 'FULL' || this.value === 'PARTIAL') {
            paymentMethodContainer.style.display = 'block';
            paymentRefContainer.style.display = 'block';
            if (this.value === 'PARTIAL') {
                partialAmountContainer.style.display = 'block';
            } else {
                partialAmountContainer.style.display = 'none';
            }
        } else {
            paymentMethodContainer.style.display = 'none';
            paymentRefContainer.style.display = 'none';
            partialAmountContainer.style.display = 'none';
        }
    });
    
    // Trigger on page load if already set
    if (paymentTypeSelect.value === 'FULL' || paymentTypeSelect.value === 'PARTIAL') {
        paymentMethodContainer.style.display = 'block';
        paymentRefContainer.style.display = 'block';
        if (paymentTypeSelect.value === 'PARTIAL') {
            partialAmountContainer.style.display = 'block';
        }
    }
    
    
    // Show OCR Preview Modal
    function showOCRPreview(data) {
        const modal = new bootstrap.Modal(document.getElementById('ocrPreviewModal'));
        const suggestions = data.suggestions || {};
        
        // Display extracted text
        const ocrTextPreview = document.getElementById('ocrTextPreview');
        if (ocrTextPreview) {
            ocrTextPreview.textContent = data.ocr_text || 'No text extracted';
        }
        
        // Display extracted information - with null checks to prevent errors
        const setTextContent = (id, value) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value || '-';
            }
        };
        
        setTextContent('previewBillNumber', suggestions.bill_number);
        setTextContent('previewBillDate', suggestions.bill_date);
        setTextContent('previewVendorName', suggestions.vendor_name);
        setTextContent('previewSubtotal', suggestions.subtotal ? '₹' + suggestions.subtotal : null);
        setTextContent('previewTax', suggestions.tax ? '₹' + suggestions.tax : null);
        setTextContent('previewTotal', suggestions.total ? '₹' + suggestions.total : null);
        setTextContent('previewTotalNet', suggestions.total_net ? '₹' + suggestions.total_net : null);
        setTextContent('previewBilledTo', suggestions.billed_to_name);
        setTextContent('previewShippedTo', suggestions.shipped_to_name);
        setTextContent('previewDeliveryDate', suggestions.delivery_date);
        setTextContent('previewDeliveryRecipient', suggestions.delivery_recipient);
        setTextContent('previewPost', suggestions.post);
        
        // Show modal
        modal.show();
    }
    
    // Confirm and Auto-fill Form
    document.getElementById('confirmOCRData').addEventListener('click', function() {
        const confirmBtn = this;
        
        if (!ocrData || !ocrData.suggestions) {
            alert('No OCR data available');
            return;
        }
        
        // Show loading state
        const originalHtml = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Filling Form...';
        
        // Use setTimeout to allow UI to update
        setTimeout(function() {
            const suggestions = ocrData.suggestions;
            console.log('Auto-filling form with suggestions:', suggestions);
            
            // Helper function to safely set field value and trigger events
            const setFieldValue = (fieldId, value) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                    // Trigger input and change events to ensure form validation and calculations work
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log(`Set ${fieldId} to:`, value);
                    return true;
                } else {
                    if (!field) {
                        console.warn(`Field ${fieldId} not found in DOM`);
                    } else if (!value) {
                        console.log(`No value provided for ${fieldId}`);
                    }
                    return false;
                }
            };
            
            // Fill bill number (Invoice Number)
            setFieldValue('bill_number', suggestions.bill_number);
            
            // Fill bill date
            setFieldValue('bill_date', suggestions.bill_date);
            
            // Fill delivery date
            setFieldValue('delivery_date', suggestions.delivery_date);
            
            // Fill billed to name
            setFieldValue('billed_to_name', suggestions.billed_to_name);
            
            // Fill shipped to name
            setFieldValue('shipped_to_name', suggestions.shipped_to_name);
            
            // Fill delivery recipient (DR)
            setFieldValue('delivery_recipient', suggestions.delivery_recipient);
            
            // Fill post
            setFieldValue('post', suggestions.post);
            
            // Fill amounts from OCR if available
            if (suggestions.subtotal) {
                setFieldValue('subtotal', suggestions.subtotal);
            }
            if (suggestions.tax) {
                setFieldValue('tax', suggestions.tax);
            }
            if (suggestions.total) {
                setFieldValue('total', suggestions.total);
            } else if (suggestions.total_net) {
                // Use total_net as total if total is not available
                setFieldValue('total', suggestions.total_net);
            }
            
            // Close modal
            const modalElement = document.getElementById('ocrPreviewModal');
            if (modalElement) {
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            
            // Reset button
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalHtml;
            
            // Scroll to form
            document.getElementById('billForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    });
    
});
</script>
{% endblock %}
