{% extends "base.html" %}

{% block title %}New Bill - Skanda Credit & Billing{% endblock %}

{% block content %}
<h1 class="mb-4">New Bill</h1>

<!-- OCR Upload Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-bottom py-3">
        <h5 class="mb-0"><i class="bi bi-camera me-2"></i>Upload Bill Image (Optional - OCR)</h5>
    </div>
    <div class="card-body p-4">
        <div class="mb-3">
            <label for="ocr_image" class="form-label">Upload Bill Image for OCR</label>
            <input type="file" class="form-control" id="ocr_image" accept="image/*,.pdf">
            <small class="form-text text-muted">Upload an image to extract bill information automatically</small>
        </div>
        <button type="button" class="btn btn-primary" id="uploadOCR">
            <i class="bi bi-upload me-2"></i>Upload & Extract
        </button>
    </div>
</div>

<!-- OCR Preview Modal -->
<div class="modal fade" id="ocrPreviewModal" tabindex="-1" aria-labelledby="ocrPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="ocrPreviewModalLabel">
                    <i class="bi bi-check-circle me-2"></i>OCR Data Extracted
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Please review the extracted data below and confirm to auto-fill the form.</strong>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary mb-2"><i class="bi bi-file-text me-2"></i>Extracted Text:</h6>
                    <pre id="ocrTextPreview" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-size: 0.875rem;"></pre>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6 class="text-primary mb-2"><i class="bi bi-card-text me-2"></i>Extracted Information:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <tbody>
                                    <tr>
                                        <td class="fw-semibold" style="width: 40%;">Bill Number:</td>
                                        <td id="previewBillNumber" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Bill Date:</td>
                                        <td id="previewBillDate" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Vendor Name:</td>
                                        <td id="previewVendorName" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Subtotal:</td>
                                        <td id="previewSubtotal" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Tax:</td>
                                        <td id="previewTax" class="text-muted">-</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-semibold">Total:</td>
                                        <td id="previewTotal" class="fw-bold text-primary">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary mb-2"><i class="bi bi-list-ul me-2"></i>Extracted Items:</h6>
                        <div id="previewItems" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted mb-0">No items extracted</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmOCRData">
                    <i class="bi bi-check-circle me-2"></i>Confirm & Auto-Fill Form
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" id="billForm" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            <div class="row mb-3">
                <div class="col-md-6">
                    {{ form.vendor_id.label(class="form-label") }}
                    {{ form.vendor_id(class="form-select") }}
                    {% if form.vendor_id.errors %}
                        <div class="text-danger small">{{ form.vendor_id.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {{ form.bill_number.label(class="form-label") }}
                    {{ form.bill_number(class="form-control") }}
                    {% if form.bill_number.errors %}
                        <div class="text-danger small">{{ form.bill_number.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    {{ form.bill_date.label(class="form-label") }}
                    {{ form.bill_date(class="form-control") }}
                    {% if form.bill_date.errors %}
                        <div class="text-danger small">{{ form.bill_date.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    {{ form.bill_type.label(class="form-label") }}
                    {{ form.bill_type(class="form-select") }}
                    {% if form.bill_type.errors %}
                        <div class="text-danger small">{{ form.bill_type.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    {{ form.is_proxy.label(class="form-label") }}
                    {{ form.is_proxy(class="form-select") }}
                    {% if form.is_proxy.errors %}
                        <div class="text-danger small">{{ form.is_proxy.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4" id="splitsContainer" style="display: none;">
                    {{ form.number_of_splits.label(class="form-label") }}
                    {{ form.number_of_splits(class="form-control") }}
                    {% if form.number_of_splits.errors %}
                        <div class="text-danger small">{{ form.number_of_splits.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            
            <hr>
            <h5>Payment Information</h5>
            <div class="row mb-3">
                <div class="col-md-3">
                    {{ form.payment_type.label(class="form-label") }}
                    {{ form.payment_type(class="form-select") }}
                    {% if form.payment_type.errors %}
                        <div class="text-danger small">{{ form.payment_type.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3" id="partialAmountContainer" style="display: none;">
                    {{ form.partial_amount.label(class="form-label") }}
                    {{ form.partial_amount(class="form-control") }}
                    {% if form.partial_amount.errors %}
                        <div class="text-danger small">{{ form.partial_amount.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3" id="paymentMethodContainer" style="display: none;">
                    {{ form.payment_method.label(class="form-label") }}
                    {{ form.payment_method(class="form-select") }}
                    {% if form.payment_method.errors %}
                        <div class="text-danger small">{{ form.payment_method.errors[0] }}</div>
                    {% endif %}
                </div>
                <div class="col-md-3" id="paymentRefContainer" style="display: none;">
                    {{ form.payment_reference.label(class="form-label") }}
                    {{ form.payment_reference(class="form-control") }}
                    {% if form.payment_reference.errors %}
                        <div class="text-danger small">{{ form.payment_reference.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>
            
            <hr>
            <h5>Items</h5>
            <div id="itemsContainer">
                <div class="item-row mb-2">
                    <div class="row g-2">
                        <div class="col-md-5">
                            <input type="text" name="item_description[]" class="form-control" placeholder="Description" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" step="0.01" name="item_quantity[]" class="form-control qty" placeholder="Qty" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" step="0.01" name="item_unit_price[]" class="form-control price" placeholder="Price" required>
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="item_amount[]" class="form-control amount" placeholder="Amount" readonly>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm mb-3" id="addItem">Add Item</button>
            
            <hr>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Subtotal</label>
                    <input type="text" class="form-control" id="subtotal" value="0.00" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tax (18%)</label>
                    <input type="text" class="form-control" id="tax" value="0.00" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Total</label>
                    <input type="text" class="form-control" id="total" value="0.00" readonly>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Bill</button>
                <a href="{{ url_for('bill.list') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('itemsContainer');
    const addBtn = document.getElementById('addItem');
    const isProxySelect = document.getElementById('is_proxy');
    const splitsContainer = document.getElementById('splitsContainer');
    const uploadOCRBtn = document.getElementById('uploadOCR');
    const ocrImageInput = document.getElementById('ocr_image');
    const ocrResult = document.getElementById('ocrResult');
    const ocrText = document.getElementById('ocrText');
    const useOCRDataBtn = document.getElementById('useOCRData');
    
    const paymentTypeSelect = document.getElementById('payment_type');
    const partialAmountContainer = document.getElementById('partialAmountContainer');
    const paymentMethodContainer = document.getElementById('paymentMethodContainer');
    const paymentRefContainer = document.getElementById('paymentRefContainer');
    
    // Show/hide splits field based on proxy selection
    isProxySelect.addEventListener('change', function() {
        if (this.value === 'YES') {
            splitsContainer.style.display = 'block';
        } else {
            splitsContainer.style.display = 'none';
        }
    });
    
    // Show/hide payment fields based on payment type
    paymentTypeSelect.addEventListener('change', function() {
        if (this.value === 'FULL' || this.value === 'PARTIAL') {
            paymentMethodContainer.style.display = 'block';
            paymentRefContainer.style.display = 'block';
            if (this.value === 'PARTIAL') {
                partialAmountContainer.style.display = 'block';
            } else {
                partialAmountContainer.style.display = 'none';
            }
        } else {
            paymentMethodContainer.style.display = 'none';
            paymentRefContainer.style.display = 'none';
            partialAmountContainer.style.display = 'none';
        }
    });
    
    // Trigger on page load if already set
    if (paymentTypeSelect.value === 'FULL' || paymentTypeSelect.value === 'PARTIAL') {
        paymentMethodContainer.style.display = 'block';
        paymentRefContainer.style.display = 'block';
        if (paymentTypeSelect.value === 'PARTIAL') {
            partialAmountContainer.style.display = 'block';
        }
    }
    
    // Store OCR data globally
    let ocrData = null;
    
    // OCR Upload
    uploadOCRBtn.addEventListener('click', function() {
        const file = ocrImageInput.files[0];
        if (!file) {
            alert('Please select an image file');
            return;
        }
        
        const formData = new FormData();
        formData.append('ocr_image', file);
        
        uploadOCRBtn.disabled = true;
        uploadOCRBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
        
        fetch('{{ url_for("bill.ocr_upload") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ocrData = data;
                showOCRPreview(data);
            } else {
                alert('OCR processing failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing OCR: ' + error.message);
        })
        .finally(() => {
            uploadOCRBtn.disabled = false;
            uploadOCRBtn.innerHTML = '<i class="bi bi-upload me-2"></i>Upload & Extract';
        });
    });
    
    // Show OCR Preview Modal
    function showOCRPreview(data) {
        const modal = new bootstrap.Modal(document.getElementById('ocrPreviewModal'));
        const suggestions = data.suggestions || {};
        
        // Display extracted text
        document.getElementById('ocrTextPreview').textContent = data.ocr_text || 'No text extracted';
        
        // Display extracted information
        document.getElementById('previewBillNumber').textContent = suggestions.bill_number || '-';
        document.getElementById('previewBillDate').textContent = suggestions.bill_date || '-';
        document.getElementById('previewVendorName').textContent = suggestions.vendor_name || '-';
        document.getElementById('previewSubtotal').textContent = suggestions.subtotal ? '₹' + suggestions.subtotal : '-';
        document.getElementById('previewTax').textContent = suggestions.tax ? '₹' + suggestions.tax : '-';
        document.getElementById('previewTotal').textContent = suggestions.total ? '₹' + suggestions.total : '-';
        
        // Display extracted items
        const itemsContainer = document.getElementById('previewItems');
        if (suggestions.items && suggestions.items.length > 0) {
            let itemsHtml = '<table class="table table-sm table-bordered mb-0">';
            itemsHtml += '<thead><tr><th>Description</th><th>Qty</th><th>Price</th></tr></thead><tbody>';
            suggestions.items.forEach(item => {
                itemsHtml += `<tr>
                    <td>${item.description || '-'}</td>
                    <td>${item.quantity || '-'}</td>
                    <td>₹${item.unit_price || '-'}</td>
                </tr>`;
            });
            itemsHtml += '</tbody></table>';
            itemsContainer.innerHTML = itemsHtml;
        } else {
            itemsContainer.innerHTML = '<p class="text-muted mb-0">No items extracted</p>';
        }
        
        // Show modal
        modal.show();
    }
    
    // Confirm and Auto-fill Form
    document.getElementById('confirmOCRData').addEventListener('click', function() {
        const confirmBtn = this;
        
        if (!ocrData || !ocrData.suggestions) {
            alert('No OCR data available');
            return;
        }
        
        // Show loading state
        const originalHtml = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Filling Form...';
        
        // Use setTimeout to allow UI to update
        setTimeout(function() {
            const suggestions = ocrData.suggestions;
            
            // Fill bill number
            if (suggestions.bill_number) {
                document.getElementById('bill_number').value = suggestions.bill_number;
            }
            
            // Fill bill date
            if (suggestions.bill_date) {
                document.getElementById('bill_date').value = suggestions.bill_date;
            }
            
            // Fill items
            if (suggestions.items && suggestions.items.length > 0) {
                // Clear existing items (except first one)
                const itemsContainer = document.getElementById('itemsContainer');
                const existingItems = itemsContainer.querySelectorAll('.item-row');
                existingItems.forEach((item, index) => {
                    if (index > 0) {
                        item.remove();
                    }
                });
                
                // Fill first item
                const firstItem = itemsContainer.querySelector('.item-row');
                if (firstItem) {
                    const descInput = firstItem.querySelector('input[name="item_description[]"]');
                    const qtyInput = firstItem.querySelector('input[name="item_quantity[]"]');
                    const priceInput = firstItem.querySelector('input[name="item_unit_price[]"]');
                    
                    if (suggestions.items[0]) {
                        if (descInput) descInput.value = suggestions.items[0].description || '';
                        if (qtyInput) qtyInput.value = suggestions.items[0].quantity || '';
                        if (priceInput) priceInput.value = suggestions.items[0].unit_price || '';
                    }
                }
                
                // Add additional items
                for (let i = 1; i < suggestions.items.length; i++) {
                    // Create new item row
                    const newRow = document.createElement('div');
                    newRow.className = 'item-row mb-2';
                    newRow.innerHTML = `
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" name="item_description[]" class="form-control" placeholder="Description" required>
                            </div>
                            <div class="col-md-2">
                                <input type="number" step="0.01" name="item_quantity[]" class="form-control qty" placeholder="Qty" required>
                            </div>
                            <div class="col-md-2">
                                <input type="number" step="0.01" name="item_unit_price[]" class="form-control price" placeholder="Price" required>
                            </div>
                            <div class="col-md-2">
                                <input type="text" name="item_amount[]" class="form-control amount" placeholder="Amount" readonly>
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
                            </div>
                        </div>
                    `;
                    itemsContainer.appendChild(newRow);
                    
                    // Fill the new row with data
                    if (suggestions.items[i]) {
                        const descInput = newRow.querySelector('input[name="item_description[]"]');
                        const qtyInput = newRow.querySelector('input[name="item_quantity[]"]');
                        const priceInput = newRow.querySelector('input[name="item_unit_price[]"]');
                        
                        if (descInput) descInput.value = suggestions.items[i].description || '';
                        if (qtyInput) qtyInput.value = suggestions.items[i].quantity || '';
                        if (priceInput) priceInput.value = suggestions.items[i].unit_price || '';
                    }
                    
                    // Attach event listeners to new row
                    attachEventListeners(newRow);
                }
                
                // Trigger calculation
                calculateTotals();
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('ocrPreviewModal')).hide();
            
            // Reset button
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalHtml;
            
            // Scroll to form
            document.getElementById('billForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    });
    
    // Use OCR data button (for future enhancement - could parse and fill more fields)
    useOCRDataBtn.addEventListener('click', function() {
        alert('OCR data extracted. Please review and fill in the form manually based on the extracted text.');
    });
    
    // Item management
    addBtn.addEventListener('click', function() {
        const newRow = document.createElement('div');
        newRow.className = 'item-row mb-2';
        newRow.innerHTML = `
            <div class="row g-2">
                <div class="col-md-5">
                    <input type="text" name="item_description[]" class="form-control" placeholder="Description" required>
                </div>
                <div class="col-md-2">
                    <input type="number" step="0.01" name="item_quantity[]" class="form-control qty" placeholder="Qty" required>
                </div>
                <div class="col-md-2">
                    <input type="number" step="0.01" name="item_unit_price[]" class="form-control price" placeholder="Price" required>
                </div>
                <div class="col-md-2">
                    <input type="text" name="item_amount[]" class="form-control amount" placeholder="Amount" readonly>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm remove-item">Remove</button>
                </div>
            </div>
        `;
        container.appendChild(newRow);
        attachEventListeners(newRow);
    });
    
    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            if (container.children.length > 1) {
                e.target.closest('.item-row').remove();
                calculateTotals();
            }
        }
    });
    
    function attachEventListeners(row) {
        const qty = row.querySelector('.qty');
        const price = row.querySelector('.price');
        const amount = row.querySelector('.amount');
        
        [qty, price].forEach(input => {
            input.addEventListener('input', function() {
                const q = parseFloat(qty.value) || 0;
                const p = parseFloat(price.value) || 0;
                amount.value = (q * p).toFixed(2);
                calculateTotals();
            });
        });
    }
    
    function calculateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.amount').forEach(amt => {
            subtotal += parseFloat(amt.value) || 0;
        });
        const tax = subtotal * 0.18;
        const total = subtotal + tax;
        
        document.getElementById('subtotal').value = subtotal.toFixed(2);
        document.getElementById('tax').value = tax.toFixed(2);
        document.getElementById('total').value = total.toFixed(2);
    }
    
    // Attach listeners to initial row
    document.querySelectorAll('.item-row').forEach(row => attachEventListeners(row));
});
</script>
{% endblock %}
